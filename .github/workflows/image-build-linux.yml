name: Image build

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch: # enable manual execution

jobs:
  build:
    runs-on: ubuntu-20.04

    env:
      SINGULARITY_VERSION: 3.7.2
      RECIPE_FILENAME: singularity-image.def
      IMAGE_FILENAME: image.sif

    steps:
    - name: Cancel previous runs
      uses: styfle/cancel-workflow-action@0.8.0
      with:
        access_token: ${{ github.token }}

    - uses: actions/checkout@v2

    - name: Install expect
      run: |
        sudo apt-get install expect
        which expect

    - uses: eWaterCycle/setup-singularity@v6
      with:
        singularity-version: ${{ env.SINGULARITY_VERSION }}

    - name: Singularity info
      run: |
        singularity --version

    - name: Singularity keys search
      run: |
        singularity keys search -l horothesun@gmail.com

    - name: Set Singularity Cloud token
      run: |
        mkdir -p $SINGULARITY_CONFIG_FOLDER
        echo $SINGULARITY_CLOUD_TOKEN > $SINGULARITY_SYLABS_TOKEN_FILE
        ls -lah $SINGULARITY_CONFIG_FOLDER
      env:
        SINGULARITY_CLOUD_TOKEN: ${{ secrets.SINGULARITY_CLOUD_TOKEN }}
        SINGULARITY_CONFIG_FOLDER: ~/.singularity
        SINGULARITY_SYLABS_TOKEN_FILE: ~/.singularity/sylabs-token

    - name: Set Singularity PGP secret
      run: |
        mkdir -p $SINGULARITY_SYPGP_FOLDER
        chmod 700 $SINGULARITY_SYPGP_FOLDER
        echo "$SINGULARITY_PGP_SECRET_BASE64" | base64 --decode > $SINGULARITY_PGP_SECRET_FILE
        chmod 600 $SINGULARITY_PGP_SECRET_FILE
        ls -lah $SINGULARITY_SYPGP_FOLDER
      env:
        SINGULARITY_PGP_SECRET_BASE64: ${{ secrets.SINGULARITY_PGP_SECRET_BASE64 }}
        SINGULARITY_SYPGP_FOLDER: ~/.singularity/sypgp
        SINGULARITY_PGP_SECRET_FILE: ~/.singularity/sypgp/pgp-secret

    - name: Build image
      run: |
        singularity build --fakeroot $IMAGE_FILENAME $RECIPE_FILENAME

    - name: Image info
      run: |
        ls -lah $IMAGE_FILENAME
        echo "---"
        singularity inspect $IMAGE_FILENAME
        echo "---"
        singularity inspect --deffile $IMAGE_FILENAME

    - name: Sign image
      run: |
        ./non_interactive_image_sign.sh
      env:
        IMAGE_FILENAME: ${{ env.IMAGE_FILENAME }}
        SINGULARITY_PGP_PASSPHRASE: ${{ secrets.SINGULARITY_PGP_PASSPHRASE }}

    - name: Verify image
      run: |
        singularity verify $IMAGE_FILENAME

    - name: Run image
      run: |
        singularity run $IMAGE_FILENAME

    - name: Upload artifact
      uses: actions/upload-artifact@v2
      with:
        name: image
        path: ${{ env.IMAGE_FILENAME }}
        if-no-files-found: error
